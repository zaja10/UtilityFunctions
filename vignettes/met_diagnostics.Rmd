---
title: "MET Diagnostics & Visualization"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MET Diagnostics & Visualization}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

# Introduction

Before running complex Factor Analytic models on Multi-Environment Trial (MET) data, it is crucial to inspect the dataset for:
1.  **Connectivity**: Do years or trials share enough germplasm to allow for genetic linkage?
2.  **Spatial Integrity**: Are there missing plots or irregular layouts that need padding?
3.  **Temporal Trends**: Is there a genetic trend or yield drag over time?

The `UtilityFunctions` package provides a suite of Base R visualization tools to perform these checks efficiently.

```{r setup}
library(UtilityFunctions)
```

# 1. Setup Data

We will generate a synthetic MET dataset to demonstrate these features.

```{r data_gen}
set.seed(123)
# Create a dataset with 5 years, 3 locs/year
years <- 2018:2022
data <- data.frame()

for(y in years) {
  for(l in 1:3) {
    # Approx 50 genotypes per trial
    # Some overlap between years (connectivity)
    genos <- paste0("G", sample(1:100, 50))
    
    trial_df <- data.frame(
      Year = y,
      Trial = paste0("Loc", l, "_", y),
      Genotype = genos,
      Row = rep(1:5, each=10),
      Column = rep(1:10, 5),
      Yield_bu = rnorm(50, mean=60 + (y-2018)*2, sd=10) # Genetic gain
    )
    
    # Introduce some missing spatial data in one trial
    if(y == 2019 && l == 1) {
      trial_df <- trial_df[-c(5, 15, 25), ] # Remove 3 plots
    }
    
    data <- rbind(data, trial_df)
  }
}

# Convert Yield to t/ha
data$Yield <- convert_buac_to_tha(data$Yield_bu, crop="wheat")
head(data)
```

# 2. Connectivity Analysis

Connectivity is vital for multi-year analysis. If two years share no genotypes, they cannot be analyzed in the same single-stage model effectively.

### Count-based Connectivity

The default method checks the raw count of shared genotypes. `order_by = "Year"` ensures the axes are chronological.

```{r conn_count}
plot_connectivity(data, x = "Year", trace = "Genotype", 
                  method = "count", order_by = "Year")
```

### Jaccard Connectivity (Normalized)

If trial sizes vary significantly, use the Jaccard index (Intersection / Union) to get a normalized measure of overlap (0 to 1).

```{r conn_jacc}
plot_connectivity(data, x = "Year", trace = "Genotype", 
                  method = "jaccard", order_by = "Year")
```

# 3. Spatial Integrity

### Visualizing a Trial Map

You can inspect the layout of any specific trial.

```{r map_raw}
# A complete trial
plot_trial_map(data, trial_val = "Loc1_2018", trial_col = "Trial", 
               row = "Row", col = "Column", val = "Yield")
```

### Padding Missing Plots

In `Loc1_2019`, we artificially removed plots. Let's visualize it to see the gaps (grey squares).

```{r map_gap}
# A trial with gaps
plot_trial_map(data, trial_val = "Loc1_2019", trial_col = "Trial", 
               row = "Row", col = "Column", val = "Yield")
```

### Bulk Padding

To prepare the entire dataset for spatial analysis (e.g. Spline/AR1 models), we can pad all trials at once.

```{r padding}
# Pad all trials by group
data_padded <- pad_trial_layout(data, row = "Row", col = "Column", group = "Trial")

# Check dimensions
dim(data)
dim(data_padded) # Should be larger due to added NA rows
```

# 4. Temporal Trends

Finally, we check for yield trends over time. The `plot_met_trend` function provides a 2-panel view:
1.  **Distribution**: Boxplots showing the spread of data per year.
2.  **Rate of Change**: A line plot of means with a linear regression trend line and statistics ($R^2$, Slope).

```{r trends, fig.height=8}
plot_met_trend(data, x = "Year", y = "Yield", main = "Wheat Yield Trend")
```

The regression statistics in the top-left legend quantify the genetic gain (t/ha per year).
