---
title: "Complete Workflow: From Phenotypes to Genomic Selection"
author: "Cereals Quant Genius"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Complete Workflow: From Phenotypes to Genomic Selection}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 6
)
```

# Introduction

The ASRemlFAST package provides a robust suite of tools for analyzing Multi-Environment Trial (MET) data using ASReml-R. It focuses on the Factor Analytic (FA) framework and implements the selection tools (FAST) proposed by Smith & Cullis (2018).

This vignette demonstrates two workflows:

Standard Analysis: Analyzing real maize data using a standard FA model.

Genomic Simulation: Simulating a breeding program with spatial field trends and genomic relationship matrices (GRM), then analyzing it using spatial models and genomic GxE.

Note: This vignette requires the asreml package and a valid license.

```{r, include = FALSE}
library(UtilityFunctions)
library(asreml)
library(tidyverse)
library(agridat) # For the example dataset
```

# Part 1: Standard MET Analysis (Real Data)

We will use the dasilva.maize dataset from the agridat package. This contains yield data for maize genotypes across 9 environments.

## 1. Fit the ASReml Model

We fit a Factor Analytic model of order 2 (FA2) to the Variety Ã— Environment interaction.

```{r}
# Load data
df <- dasilva.maize

# Fit FA2 Model
# Note: We assume 'env' are environments and 'gen' are genotypes
model_real <- asreml(fixed = yield ~ env,
                     random = ~fa(env, 2):gen + rep,
                     residual = ~idv(units),
                     data = df, 
                     trace = FALSE) # Suppress iteration output for vignette

# Check variance components to confirm convergence
summary(model_real)$varcomp
```

## 2. Extract FA Parameters

We use the fa.asreml function to extract loadings, scores, and specific variances. This function automatically rotates the solution to the Principal Component axis (SVD), which is required for the interpretation of FAST indices.

```{r}
# The 'classify' string must match the random term in the model
fa_summary <- fa.asreml(model_real, classify = "fa(env, 2):gen")

# Print a high-level summary
print(fa_summary)
```

## 3. Visualization Suite

Now we generate the standard decision-support plots.

#### A. The "Money Plot" (FAST)

Plots Overall Performance (OP) against Stability (RMSD). Genotypes in the top-left are high-yielding and stable.

```{r}
plot(fa_summary, type = "fast", n_label = 5)
```

#### B. Genetic Correlations (Heatmap)

Visualizes the structure of the target population of environments.

```{r}
plot(fa_summary, type = "heatmap")
```

#### C. Latent Regression (GxE Drivers)

Visualizes why specific varieties are unstable. It "peels off" Factor 1 to show the specific interaction effects driven by Factor 2.

```{r}
plot(fa_summary, type = "latent_reg", n_label = 3)

```

#### D. The Biplot

A GGE-style overview of the Genotype + Environment space.

```{r}
plot(fa_summary, type = "biplot")

```

#### E. Site Quality (VAF)

Which sites were well explained by the model?

```{r}
plot(fa_summary, type = "vaf")

```

### 4. Advanced Analytics: Interaction Classes

We calculate Interaction Classes to detect specific adaptation. This partitions environments into Positive (+) and Negative (-) classes based on Factor 2 loadings and checks for crossover interactions.

```{r}
# Calculate classes
iclass_results <- get_i_classes(fa_summary, factor = 2)


# Visualize Rank Changes (Slope Graph)
plot_differential(iclass_results, n_top = 5)
```

# Part 2: Genomic GxE & Spatial Analysis (Simulation)

In modern breeding, we often use Genomic Relationship Matrices (GRM) to model additive genetic effects (vm terms) and run spatial analysis on the field layout.

## 1. Simulate Genomic Data

We generate synthetic marker data, calculate a GRM, and simulate phenotypes that include spatial field trends (e.g., fertility gradients).

```{r}

# 1. Generate Markers and GRM (VanRaden method)
genomic_sim <- generate_grm(n_gen = 150, n_markers = 2000, seed = 123)
my_grm <- genomic_sim$grm

# 2. Generate Phenotypes driven by this GRM + Spatial Trends
# h2 = 0.6 indicates strong genetic signal
met_data <- generate_genomic_met(n_sites = 8, grm = my_grm, h2 = 0.6)

# View the spatial columns (Row, Column) created
head(met_data)
```

## 2. Pre-Analysis Diagnostics

Before fitting the model, we check if the trial network is connected. (In this simulation, it is a full factorial, so connectivity is perfect).

```{r}
check_connectivity(met_data, genotype = "Genotype", trial = "Site")
```

## 3. Fit Genomic Spatial Model

We fit a complex model:

Genetic: FA2 structure on the Additive effects (vm(Genotype, grm)).

Spatial: Autoregressive (ar1) spatial errors on Rows and Columns.

```{r}
# Fit Model
mod_genomic <- asreml(
  fixed = Yield ~ Site,
  random = ~ fa(Site, 2):vm(Genotype, my_grm) + Rep,
  residual = ~Site:ar1(Row):ar1(Column), # Spatial residuals
  data = met_data,
  trace = FALSE
)

# One update to ensure convergence
mod_genomic <- update(mod_genomic, trace = FALSE)
```

## 4. Spatial Diagnostics

We can visualize the raw data or residuals mapped to the physical field layout to check for artifacts.

```{r}
# Visualize the fitted spatial trend for Site_01
# (Requires subsetting data, or plotting residuals)
plot_spatial(mod_genomic, row_col = "Row", col_col = "Column", type = "residuals")
```

## 5. Extract Genomic Breeding Values (GEBVs)

The toolkit automatically parses the vm() wrapper to extract the correct coefficients.

```{r}
results_g <- fa.asreml(mod_genomic, classify = "fa(Site, 2):vm(Genotype, my_grm)")

```

## 6. Network Optimization (D-Optimality)

We assess the information content of the trial network. This tells us if any sites are redundant.

```{r}
d_opt <- get_d_optimality(results_g)

# Visualize Site Importance
plot(results_g, type = "d_opt")

```

7.  Genomic Selection Visuals

Finally, we view the FAST plot for the Breeding Values (Additve Effects).

```{r}
plot(results_g, type = "fast", n_label = 5)

```
